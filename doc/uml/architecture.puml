@startuml LernApp
!theme plain

' Title and styling
title LernApp - MVC Architecture Diagram

skinparam linetype ortho
skinparam componentStyle rectangle

' ============================================
' PRESENTATION LAYER (View - Frontend)
' ============================================
package "Frontend (View Layer)" as FrontendLayer #LightBlue {
    component "Angular Application" as AngularApp {
        package "Pages (Standalone Components)" as Pages {
            component "Home" as HomeComp
            component "DeckPage" as DeckComp
            component "CreateNewDeckPage" as CreateDeckComp
            component "DeckDetailPage" as DeckDetailComp
            component "DeckEditPage" as DeckEditComp
            component "DeckLearnPage" as DeckLearnComp
            component "StatisticsPage" as StatsComp
            component "LoginPage" as LoginComp
        }
        
        package "Application Services" as AppServices {
            component "AuthService" as AuthService
        }
        
        package "Generated API Services" as FrontendServices {
            component "IdentityService" as IdentityService
            component "DeckService" as DeckService
            component "CardService" as CardService
            component "ProgressService" as ProgressService
        }
        
        package "UI Framework" as UIFramework {
            component "Angular Material" as AngularMaterial
            component "Router (Lazy Loading)" as Routing
        }
    }
    
    note right of AngularApp
        **Frontend Technologies:**
        - Angular 20 (TypeScript, Standalone)
        - Angular Material
        - RxJS for reactive programming
        - OpenAPI Generator for API client
    end note
}

' ============================================
' APPLICATION LAYER (Controller)
' ============================================
package "Backend (Controller Layer)" as BackendLayer #LightGreen {
    component "ASP.NET Core Web API" as WebAPI {
        package "Controllers" as Controllers {
            component "IdentityController" as IdentityCtrl
            component "DeckController" as DecksCtrl
            component "CardController" as CardsCtrl
            component "ProgressController" as ProgressCtrl
            component "TestController" as TestCtrl
        }
        
        package "Middleware" as Middleware {
            component "Cookie Authentication" as AuthMiddleware
            component "Authorization" as AuthzMiddleware
        }
        
        package "ASP.NET Identity" as IdentityPkg {
            component "UserManager" as UserManager
            component "SignInManager" as SignInManager
            component "RoleManager" as RoleManager
        }
    }
    
    note right of WebAPI
        **Backend Technologies:**
        - .NET 8 / ASP.NET Core
        - REST API architecture
        - Cookie Authentication (ASP.NET Identity)
        - Entity Framework Core
    end note
}

' ============================================
' BUSINESS LOGIC LAYER (Model - Business Logic)
' ============================================
package "Business Logic (Model Layer)" as ModelLayer #LightYellow {
    component "Service Layer" as ServiceLayer {
        component "DeckService" as DeckServiceBL
        component "CardService" as CardServiceBL
        component "LearningService" as LearningServiceBL
    }
    
    note right of LearningServiceBL
        **Spaced Repetition Algorithm:**
        - Card states: New, Learning, Review, Relearning
        - Rating: Again, Hard, Good, Easy
        - Calculates next review date (DueDate)
        - Adjusts interval based on user rating
    end note
    
    package "Domain Entities" as DomainModels {
        component "IdentityUserEntity" as UserEntity
        component "DeckEntity" as DeckEntity
        component "CardEntity" as CardEntity
    }
    
    package "Data Models" as DataModels {
        component "CardData" as CardDataModel
        component "DeckData" as DeckDataModel
    }
    
    package "DTOs & Models" as DTOs {
        component "Request Models" as RequestDTOs
        component "Response Models" as ResponseDTOs
        component "Invoker" as InvokerModel
    }
}

' ============================================
' DATA ACCESS LAYER
' ============================================
package "Data Access Layer" as DataAccessLayer #LightCoral {
    component "Entity Framework Core" as EFCore {
        component "CoreContext" as DbContext
        component "Migrations" as Migrations
    }
    
    note right of DbContext
        **CoreContext (partial class):**
        - CoreContext.cs (base)
        - CoreContext.Identity.cs
        - CoreContext.LernApp.cs
    end note
}

' ============================================
' DATA STORAGE LAYER (Database)
' ============================================
database "Database" as Database #LightGray {
    storage "PostgreSQL" as DB {
        package "identity schema" as IdentitySchema {
            component "Users" as UsersTable
            component "Roles" as RolesTable
            component "UserRoles" as UserRolesTable
        }
        package "core schema" as CoreSchema {
            component "deck" as DecksTable
            component "card" as CardsTable
        }
    }
}

' ============================================
' RELATIONSHIPS - Frontend to Backend
' ============================================
LoginComp --> AuthService : uses
AuthService --> IdentityService
HomeComp --> AuthService
DeckComp --> DeckService
DeckComp --> AuthService
CreateDeckComp --> AuthService
CreateDeckComp --> DeckService

DeckDetailComp --> AuthService
DeckEditComp --> AuthService
DeckEditComp --> CardService
DeckEditComp --> DeckService
DeckLearnComp --> AuthService
DeckLearnComp --> ProgressService
DeckLearnComp --> DeckService
StatsComp --> AuthService
StatsComp --> DeckService
StatsComp --> CardService

DeckService -down-> WebAPI : HTTP/REST
CardService -down-> WebAPI
IdentityService -down-> WebAPI
ProgressService -down-> WebAPI

' ============================================
' RELATIONSHIPS - Backend to Business Logic
' ============================================
IdentityCtrl --> UserManager : uses
IdentityCtrl --> SignInManager
DecksCtrl --> DeckServiceBL : calls
CardsCtrl --> CardServiceBL
ProgressCtrl --> LearningServiceBL

' ============================================
' RELATIONSHIPS - Business Logic to Data Access
' ============================================
DeckServiceBL --> DbContext : uses
CardServiceBL --> DbContext
LearningServiceBL --> DbContext

DeckServiceBL --> DeckEntity : manages
CardServiceBL --> CardEntity
LearningServiceBL --> CardEntity

' ============================================
' RELATIONSHIPS - Data Access to Database
' ============================================
DbContext -down-> Database : queries/updates

' ============================================
' LEGEND
' ============================================
legend right
    **MVC Pattern Mapping:**
    |= Layer |= MVC Component |
    | Frontend (Blue) | **View** - User Interface |
    | Backend Controllers (Green) | **Controller** - Request Handler |
    | Business Logic (Yellow) | **Model** - Business Rules & Data |
    | Data Access (Red) | **Model** - Data Persistence |
    | Database (Gray) | **Model** - Data Storage |
    
    **Communication:**
    - Frontend ↔ Backend: REST API (HTTP/JSON)
    - Backend ↔ Database: Entity Framework Core (direct, no repository)
    - Authentication: Cookie-based (ASP.NET Identity)
endlegend

@enduml
